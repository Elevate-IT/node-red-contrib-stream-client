<script type="text/x-red" data-template-name="stream-client">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Optional name for the node">
  </div>
  <div class="form-row">
    <label for="node-input-url"><i class="fa fa-globe"></i> URL</label>
    <input type="text" id="node-input-url" placeholder="e.g., ws://localhost:8080/stream" required>
  </div>
  <div class="form-row">
    <label for="node-input-token"><i class="fa fa-key"></i> Bearer Token</label>
    <input type="text" id="node-input-token" placeholder="Optional Bearer token for authentication">
  </div>
  <div class="form-row">
    <label for="node-input-headers"><i class="fa fa-header"></i> Extra Headers (JSON)</label>
    <input type="text" id="node-input-headers" placeholder='e.g., {"Authorization": "Basic xyz"}'>
  </div>
  <div class="form-row">
    <label for="node-input-query"><i class="fa fa-question"></i> Query Params (key=value&...)</label>
    <input type="text" id="node-input-query" placeholder="e.g., param1=value1&param2=value2">
  </div>
  <div class="form-row">
    <label for="node-input-reconnectDelay"><i class="fa fa-clock-o"></i> Reconnect Delay (ms)</label>
    <input type="number" id="node-input-reconnectDelay" min="0" placeholder="e.g., 5000">
  </div>
  <div class="form-row">
    <label for="node-input-debug"><i class="fa fa-bug"></i> Debug</label>
    <input type="checkbox" id="node-input-debug">
  </div>
</script>

<script type="text/javascript">
  RED.nodes.registerType('stream-client', {
    category: 'input',
    color: '#a6bbcf',
    defaults: {
      name: { value: '' }, // Node name (string)
      url: { value: '', required: true }, // Stream URL (string, required)
      token: { value: '' }, // Bearer Token (string)
      headers: { value: '' }, // Extra Headers (JSON string)
      query: { value: '' }, // Query Parameters (key=value&... string)
      reconnectDelay: { value: 5000 }, // Reconnect Delay in milliseconds (number)
      debug: { value: false } // Debug mode (boolean)
    },
    inputs: 0,
    outputs: 1,
    icon: 'font-awesome/fa-plug',
    label: function () {
      return this.name || 'stream-client'; // Use the node's name, or 'stream-client' if no name is set.
    },
    // Function called when the node's properties editor is opened.
    oneditprepare: function () {
      $("#node-input-name").val(this.name);
      $("#node-input-url").val(this.url);
      $("#node-input-token").val(this.token);
      $("#node-input-headers").val(this.headers);
      $("#node-input-query").val(this.query);
      $("#node-input-reconnectDelay").val(this.reconnectDelay);
      // For checkboxes, use .prop('checked', true/false) instead of .val().
      $("#node-input-debug").prop('checked', this.debug);
      console.log("Stream-client editor opened and fields populated.");
    },
    oneditsave: function() {
        console.log("Stream-client editor saved.");
    },
    oneditcancel: function() {
        console.log("Stream-client editor cancelled.");
    }
  });
</script>


<script type="text/x-red" data-help-name="stream-client">
  <p>
    The <strong>Stream Client</strong> node connects to an HTTP or HTTPS endpoint that emits
    newline-delimited JSON (NDJSON). It reads the stream line-by-line and sends each parsed line
    as a separate message.
  </p>

  <h3>Inputs</h3>
  <p>This node does not accept any inputs.</p>

  <h3>Outputs</h3>
  <p>Sends one message per line received from the NDJSON stream:</p>
  <pre>{
  "payload": { ...parsed JSON line... }
}</pre>

  <h3>Configuration</h3>
  <dl>
    <dt><strong>URL</strong> (required)</dt>
    <dd>The full stream URL (e.g., <code>https://example.com/api/stream</code>).</dd>

    <dt><strong>Bearer Token</strong></dt>
    <dd>Optional token to send as an <code>Authorization: Bearer &lt;token&gt;</code> header.</dd>

    <dt><strong>Extra Headers (JSON)</strong></dt>
    <dd>Additional headers to include in the request, as a JSON object (e.g., <code>{"X-Custom": "123"}</code>).</dd>

    <dt><strong>Query Params</strong></dt>
    <dd>URL query string (e.g., <code>type=event&id=42</code>). These are added to the end of the URL.</dd>

    <dt><strong>Reconnect Delay (ms)</strong></dt>
    <dd>Time in milliseconds to wait before attempting to reconnect if the stream closes or fails. Default is <code>5000</code>.</dd>

    <dt><strong>Debug</strong></dt>
    <dd>If enabled, logs connection details and events to the Node-RED log for debugging.</dd>
  </dl>

  <h3>Status</h3>
  <ul>
    <li><code>connecting</code> – Attempting to establish connection</li>
    <li><code>connected</code> – Stream is active and data is being received</li>
    <li><code>disconnected</code> – Stream ended or closed</li>
    <li><code>error</code> – Connection error occurred</li>
  </ul>

  <h3>Use Cases</h3>
  <ul>
    <li>Real-time event streams</li>
    <li>Webhook-style endpoints emitting NDJSON</li>
    <li>Telemetry or sensor feeds</li>
  </ul>
</script>